# Seata Server - Distributed Transaction Coordinator

[![Rust](https://img.shields.io/badge/rust-1.75+-orange.svg)](https://www.rust-lang.org/)
[![License](https://img.shields.io/badge/license-MIT-blue.svg)](LICENSE)
[![Docker](https://img.shields.io/badge/docker-ready-blue.svg)](docker-compose.yml)

A high-performance distributed transaction coordinator implemented in Rust, providing Saga and TCC transaction patterns with comprehensive monitoring and production-ready features.

## üöÄ Quick Start

### Prerequisites
- Rust 1.75+ 
- Docker & Docker Compose
- Redis, MySQL, or PostgreSQL (for production)

### Installation

```bash
# Clone the repository
git clone https://github.com/your-org/seata-server.git
cd seata-server

# Build the project
cargo build --release

# Run with Docker (recommended)
docker-compose up -d

# Or run locally
cargo run -p seata-server
```

### Test the API

```bash
# Health check
curl http://localhost:36789/health

# Create a transaction
curl -X POST http://localhost:36789/api/start \
  -H 'content-type: application/json' \
  -d '{}'

# Run comprehensive tests
./scripts/test-api.sh
```

## üìã Table of Contents

- [Features](#features)
- [Architecture](#architecture)
- [API Documentation](#api-documentation)
- [Configuration](#configuration)
- [Deployment](#deployment)
- [Monitoring](#monitoring)
- [Development](#development)
- [Contributing](#contributing)

## ‚ú® Features

### Core Transaction Management
- ‚úÖ **Saga Pattern**: Complete implementation with branch execution and rollback
- ‚úÖ **TCC Pattern**: Try-Confirm-Cancel with barrier idempotency
- ‚úÖ **Concurrent Execution**: Configurable branch parallelism
- ‚úÖ **Retry Logic**: Timeout and retry mechanisms
- ‚úÖ **Status Management**: Global and branch status tracking

### Storage Backends
- ‚úÖ **Redis**: High-performance in-memory storage
- ‚úÖ **MySQL**: Persistent storage with SeaORM
- ‚úÖ **PostgreSQL**: ACID-compliant storage
- ‚úÖ **Sled**: Embedded database for development

### API Interfaces
- ‚úÖ **HTTP REST API**: Complete REST endpoints
- ‚úÖ **gRPC API**: High-performance gRPC service
- ‚úÖ **Query Operations**: Pagination and filtering
- ‚úÖ **Health Checks**: Service monitoring

### Monitoring & Observability
- ‚úÖ **Prometheus Metrics**: Success/failure counters, latency histograms
- ‚úÖ **Structured Logging**: Comprehensive logging with tracing
- ‚úÖ **Health Endpoints**: Service status monitoring

## üèóÔ∏è Architecture

### System Components

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   HTTP Client   ‚îÇ    ‚îÇ   gRPC Client   ‚îÇ    ‚îÇ   Admin UI      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ                      ‚îÇ                      ‚îÇ
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                 ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ     Seata Server          ‚îÇ
                    ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
                    ‚îÇ  ‚îÇ   HTTP API (36789)  ‚îÇ  ‚îÇ
                    ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
                    ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
                    ‚îÇ  ‚îÇ   gRPC API (36790)  ‚îÇ  ‚îÇ
                    ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ    Transaction Manager    ‚îÇ
                    ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
                    ‚îÇ  ‚îÇ   Saga Manager      ‚îÇ  ‚îÇ
                    ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
                    ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
                    ‚îÇ  ‚îÇ   TCC Manager       ‚îÇ  ‚îÇ
                    ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
                    ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
                    ‚îÇ  ‚îÇ   Barrier Manager   ‚îÇ  ‚îÇ
                    ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ     Storage Layer        ‚îÇ
                    ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
                    ‚îÇ  ‚îÇ   Redis / MySQL     ‚îÇ  ‚îÇ
                    ‚îÇ  ‚îÇ   PostgreSQL / Sled ‚îÇ  ‚îÇ
                    ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Transaction Flow

#### Saga Pattern
```
Start ‚Üí Add Branches ‚Üí Submit ‚Üí Execute Branches ‚Üí Commit/Abort
  ‚Üì         ‚Üì           ‚Üì           ‚Üì              ‚Üì
Create   Prepare    Validate    HTTP Calls    Update Status
```

#### TCC Pattern
```
Start ‚Üí Try Phase ‚Üí Confirm/Cancel ‚Üí Update Status
  ‚Üì        ‚Üì           ‚Üì              ‚Üì
Create   Reserve    Finalize      Complete
```

## üìö API Documentation

### Base URL
```
http://localhost:36789
```

### Authentication
No authentication required for basic operations.

### Content Types
- **Request**: `application/json`
- **Response**: `application/json`

### Error Handling
All endpoints return appropriate HTTP status codes:
- `200 OK`: Success
- `400 Bad Request`: Invalid request format
- `404 Not Found`: Transaction not found
- `500 Internal Server Error`: Server error

## üîß Configuration

### Environment Variables

```bash
# Storage backend
export SEATA_STORE=redis  # or mysql, postgres, sled

# Redis configuration
export SEATA_REDIS_URL=redis://127.0.0.1/
# With password
# export SEATA_REDIS_URL=redis://:password@127.0.0.1:6379/0

# MySQL configuration (DSN)
export SEATA_MYSQL_DSN=mysql://user:pass@localhost:3306/seata

# PostgreSQL configuration (DSN)
export SEATA_POSTGRES_DSN=postgres://user:pass@localhost:5432/seata

# Server ports
export SEATA_HTTP_PORT=36789
export SEATA_GRPC_PORT=36790

# Execution settings
export SEATA_REQUEST_TIMEOUT_SECS=30
export SEATA_RETRY_INTERVAL_SECS=1
export SEATA_TIMEOUT_TO_FAIL_SECS=60
export SEATA_BRANCH_PARALLELISM=10

# Connection pool (for MySQL/Postgres via SeaORM)
export SEATA_MAX_OPEN_CONNS=200
export SEATA_MAX_IDLE_CONNS=20
export SEATA_CONN_MAX_LIFE_TIME_MINUTES=30
```

### Configuration File

Create `conf.yaml` in the server directory:

```yaml
server:
  http_port: 36789
  grpc_port: 36790

store:
  type: redis
  redis:
    # If password is required, prefer configuring via URL. Empty password means no AUTH.
    # Examples:
    #   redis://127.0.0.1:6379/0
    #   redis://:password@127.0.0.1:6379/0
    url: redis://127.0.0.1/

exec:
  request_timeout_secs: 30
  retry_interval_secs: 1
  timeout_to_fail_secs: 60
  branch_parallelism: 10
```

## üöÄ Deployment

### Docker Deployment (Recommended)

```bash
# Start all services
docker-compose up -d

# High concurrency override (compose v2+)
docker compose -f docker-compose.yml -f docker-compose.override.yml up -d

# Check service status
docker-compose ps

# View logs
docker-compose logs -f seata-server
```

### Manual Deployment

```bash
# Build the application
cargo build --release

# Run with configuration
SEATA_STORE=redis SEATA_REDIS_URL=redis://127.0.0.1/ \
  cargo run -p seata-server
```

### Production Deployment

1. **Use production storage backend** (Redis preferred for high throughputÔºõMySQL/PostgreSQL for audit/ACID)
2. **Configure monitoring** (Prometheus/Grafana)
3. **Set up load balancing** for high availability
4. **Configure backup strategies** for data persistence

### Kubernetes Deployment (Examples)

```bash
# Redis Cluster for high QPS
kubectl apply -f seata/k8s/redis-cluster.yaml

# Seata 50k QPS tuned deployment + service + HPA
kubectl apply -f seata/k8s/seata-server-50k.yaml

# Ingress with TLS (requires cert-manager installed)
kubectl apply -f seata/k8s/cert-issuer.yaml
kubectl apply -f seata/k8s/ingress.yaml

# Optional: Gateway API variant
# kubectl apply -f seata/k8s/gateway.yaml

# k6 load test (50k rps target)
kubectl apply -f seata/k8s/k6-loadtest.yaml
```

> Replace `seata.example.com` and `admin@example.com` with your domain/email.

## üìä Monitoring

### Metrics Endpoints

```bash
# Health check
curl http://localhost:36789/health

# Prometheus metrics
curl http://localhost:36789/metrics
```

### Key Metrics

- `seata_branch_success_total`: Successful branch executions
- `seata_branch_failure_total`: Failed branch executions
- `seata_branch_latency_seconds`: Branch execution latency
- `seata_active_transactions`: Currently active transactions

### Grafana Dashboard

Access Grafana at `http://localhost:3000` (admin/admin123) for:
- Transaction rates and success rates
- Branch execution performance
- Error rates and latency
- System health monitoring

## üõ†Ô∏è Development

### Prerequisites
- Rust 1.75+
- Docker & Docker Compose
- Git

### Setup Development Environment

```bash
# Clone repository
git clone https://github.com/your-org/seata-server.git
cd seata-server

# Start development environment
docker-compose -f docker-compose.dev.yml up -d

# Run tests
cargo test

# Run with hot reload
cargo watch -x "run -p seata-server"
```

### Project Structure

```
seata/
‚îú‚îÄ‚îÄ seata-proto/          # Protocol definitions
‚îÇ   ‚îú‚îÄ‚îÄ proto/            # gRPC proto files
‚îÇ   ‚îî‚îÄ‚îÄ src/              # Generated Rust code
‚îú‚îÄ‚îÄ seata-server/         # Main server implementation
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ domain.rs     # Domain models
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ repo.rs       # Repository traits
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ saga.rs       # Saga implementation
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ barrier.rs    # Barrier implementation
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ storage/      # Storage backends
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main.rs       # Application entry point
‚îÇ   ‚îî‚îÄ‚îÄ Cargo.toml
‚îú‚îÄ‚îÄ docker-compose.yml    # Production Docker setup
‚îú‚îÄ‚îÄ docker-compose.dev.yml # Development Docker setup
‚îî‚îÄ‚îÄ README.md
```

### Running Tests

```bash
# Run all tests
cargo test

# Run specific test categories
cargo test business_scenario_tests
cargo test integration_tests
cargo test performance_tests

# Run with coverage
cargo test --lib -- --nocapture
```

### Code Quality

```bash
# Format code
cargo fmt

# Lint code
cargo clippy

# Check for security issues
cargo audit
```

## üìà Performance

### Benchmarks

- **Transaction Creation**: < 1ms per transaction
- **Branch Execution**: Concurrent processing with configurable limits
- **Memory Usage**: Efficient memory management for large datasets
- **Throughput**: 1000+ transactions per second
- **Latency**: Sub-second response times for most operations

### Optimization Tips

1. **Use Redis (Cluster) for high throughput**
2. **Tune branch_parallelism (e.g., 32‚Äì192)**
3. **Short timeouts + jittered retries**
4. **Enable HTTP compression and shared clients**
5. **Use SeaORM pool with proper max/min connections**
6. **Monitor P95/P99 latency and failure rate**

## üîí Security

### Best Practices

1. **Network Security**: Use TLS for production deployments
2. **Access Control**: Implement authentication for production
3. **Data Encryption**: Encrypt sensitive data in transit and at rest
4. **Audit Logging**: Enable comprehensive audit trails
5. **Regular Updates**: Keep dependencies updated

### Security Considerations

- No authentication by default (add for production)
- Input validation on all endpoints
- Rate limiting for API endpoints
- Secure storage backend configuration

## ü§ù Contributing

### Development Workflow

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests for new functionality
5. Ensure all tests pass
6. Submit a pull request

### Code Standards

- Follow Rust naming conventions
- Add comprehensive tests
- Document public APIs
- Use meaningful commit messages
- Update documentation for new features

### Testing Requirements

- Unit tests for all new functionality
- Integration tests for API endpoints
- Performance tests for critical paths
- Documentation updates for API changes

## üìÑ License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

## üôè Acknowledgments

- [DTM](https://github.com/dtm-labs/dtm) - Inspiration for distributed transaction patterns
- [Seata](https://github.com/seata/seata) - Reference implementation
- [Rust](https://www.rust-lang.org/) - The amazing systems programming language
- [Tokio](https://tokio.rs/) - Async runtime for Rust
- [Axum](https://github.com/tokio-rs/axum) - Web framework
- [Tonic](https://github.com/hyperium/tonic) - gRPC framework

## üìû Support

- **Documentation**: [API Usage Guide](seata-server/API_USAGE.md)
- **Docker Guide**: [Docker Setup](README-Docker.md)
- **Issues**: [GitHub Issues](https://github.com/your-org/seata-server/issues)
- **Discussions**: [GitHub Discussions](https://github.com/your-org/seata-server/discussions)

---

**Built with ‚ù§Ô∏è in Rust**

